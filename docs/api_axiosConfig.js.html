<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>api/axiosConfig.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-hooks_api.html">hooks/api</a></li></ul><h3>Global</h3><ul><li><a href="global.html#API">API</a></li><li><a href="global.html#ActionAPI">ActionAPI</a></li><li><a href="global.html#App">App</a></li><li><a href="global.html#AuthAPI">AuthAPI</a></li><li><a href="global.html#AuthProvider">AuthProvider</a></li><li><a href="global.html#Footer">Footer</a></li><li><a href="global.html#GaugeBrightness">GaugeBrightness</a></li><li><a href="global.html#GaugeCard">GaugeCard</a></li><li><a href="global.html#GaugeHumidity">GaugeHumidity</a></li><li><a href="global.html#GaugeIdealRadial">GaugeIdealRadial</a></li><li><a href="global.html#GaugeMultiZoneRadial">GaugeMultiZoneRadial</a></li><li><a href="global.html#GaugeTemperature">GaugeTemperature</a></li><li><a href="global.html#GreenhouseAPI">GreenhouseAPI</a></li><li><a href="global.html#GreenhouseCard">GreenhouseCard</a></li><li><a href="global.html#GreenhouseForm">GreenhouseForm</a></li><li><a href="global.html#Header">Header</a></li><li><a href="global.html#HealthAPI">HealthAPI</a></li><li><a href="global.html#NotificationAPI">NotificationAPI</a></li><li><a href="global.html#PresetAPI">PresetAPI</a></li><li><a href="global.html#RequireAuth">RequireAuth</a></li><li><a href="global.html#SensorAPI">SensorAPI</a></li><li><a href="global.html#UserAPI">UserAPI</a></li><li><a href="global.html#authPath">authPath</a></li><li><a href="global.html#checkAuth">checkAuth</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#failedQueue">failedQueue</a></li><li><a href="global.html#getBrowserSubscription">getBrowserSubscription</a></li><li><a href="global.html#getPermissionStatus">getPermissionStatus</a></li><li><a href="global.html#isPushSupported">isPushSupported</a></li><li><a href="global.html#isRefreshing">isRefreshing</a></li><li><a href="global.html#normalizeSubscription">normalizeSubscription</a></li><li><a href="global.html#processQueue">processQueue</a></li><li><a href="global.html#resolveOffset">resolveOffset</a></li><li><a href="global.html#root">root</a></li><li><a href="global.html#router">router</a></li><li><a href="global.html#routes">routes</a></li><li><a href="global.html#secureChildren">secureChildren</a></li><li><a href="global.html#showPushPermissionPrompt">showPushPermissionPrompt</a></li><li><a href="global.html#urlBase64ToUint8Array">urlBase64ToUint8Array</a></li><li><a href="global.html#useAction">useAction</a></li><li><a href="global.html#useApiUtils">useApiUtils</a></li><li><a href="global.html#useAuth">useAuth</a></li><li><a href="global.html#useCSSVar">useCSSVar</a></li><li><a href="global.html#useCommonGaugeTheme">useCommonGaugeTheme</a></li><li><a href="global.html#useGreenhouse">useGreenhouse</a></li><li><a href="global.html#useHealth">useHealth</a></li><li><a href="global.html#useNotification">useNotification</a></li><li><a href="global.html#usePreset">usePreset</a></li><li><a href="global.html#usePush">usePush</a></li><li><a href="global.html#useUser">useUser</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">api/axiosConfig.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file axiosConfig.js
 * @description Axios configuration for SmartGrow frontend.
 *
 * This file provides a shared Axios instance (`API`) preconfigured with:
 * - Base URL (depending on environment)
 * - Automatic `Authorization` header injection
 * - Transparent access token refreshing using refresh token
 * - Safe retry of original request upon 401
 * - Queued request handling during refresh
 *
 * Any service making authenticated HTTP requests should import and use `API`.
 * @author Taggerkov
 * @version 1.2.0
 * @since 0.7.0
 * @see axios
 */

import axios from 'axios';

/**
 * API subroute path used for composing REST endpoints.
 *
 * Kept in sync with backend controller route attributes.
 * @type {string}
 */
const authPath = 'Auth', userPath='User', greenhousePath='Greenhouse', sensorPath = 'SensorReading', actionPath = 'Action', presetPath = 'Preset', notificationPath='Notification', healthPath = 'Health';

/**
 * Axios instance preconfigured with baseURL and JSON content headers.
 * @type {import('axios').AxiosInstance}
 */
const API = axios.create({
    baseURL: process.env.NODE_ENV === 'production' ? 'https://myapp.com/api/' : 'http://localhost:5050/api/',
    headers: {
        'Content-Type': 'application/json',
    }
});

/**
 * Flag indicating whether the token is currently being refreshed.
 * @type {boolean}
 */
let isRefreshing = false;

/**
 * Queue of pending requests while the token is refreshing.
 * Each entry is an object with resolve and reject callbacks.
 * @type {{ resolve: (token: string) => void, reject: (err: any) => void }[]}
 */
let failedQueue = [];

/**
 * Resolves or rejects all queued requests depending on a refresh outcome.
 * @param {any} error - If present, all queued requests will reject with this error.
 * @param {string|null} token - If provided, queued requests will retry using this token.
 */
const processQueue = (error, token = null) => {
    failedQueue.forEach(({resolve, reject}) => error ? reject(error) : resolve(token));
    failedQueue = [];
};

// Request interceptor: Automatically attaches the access token (if present) to outgoing requests.
API.interceptors.request.use((config) => {
    const token = localStorage.getItem('accessToken');
    if (token) config.headers.Authorization = `Bearer ${token}`;
    return config;
});

/*
 * Response interceptor:
 * - Handles 401 Unauthorized responses by attempting a token refresh.
 * - Retries the original request after a successful refresh.
 * - Skip refresh for any /auth/* route to avoid recursion.
 */
API.interceptors.response.use(response => response, async error => {
        const originalRequest = error.config;
        if (error.response?.status === 401 &amp;&amp; !originalRequest._retry &amp;&amp; !originalRequest.url.includes(`${authPath}/login`) &amp;&amp; !originalRequest.url.includes(`${authPath}/register`) &amp;&amp; !originalRequest.url.includes(`${authPath}/refresh`)) {
            originalRequest._retry = true;
            if (isRefreshing) return new Promise((resolve, reject) => failedQueue.push({resolve, reject})).then((token) => {
                originalRequest.headers.Authorization = `Bearer ${token}`;
                return API(originalRequest);
            }).catch(err => Promise.reject(err));
            isRefreshing = true;
            const refreshToken = localStorage.getItem('refreshToken');
            try {
                const res = await API.post(`${authPath}/refresh`, refreshToken);
                const {token: newAccessToken, refreshToken: newRefreshToken} = res.data;
                localStorage.setItem('accessToken', newAccessToken);
                localStorage.setItem('refreshToken', newRefreshToken);
                API.defaults.headers.common.Authorization = `Bearer ${newAccessToken}`;
                processQueue(null, newAccessToken);
                originalRequest.headers.Authorization = `Bearer ${newAccessToken}`;
                return API(originalRequest);
            } catch (refreshErr) {
                processQueue(refreshErr, null);
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/';
                return Promise.reject(refreshErr);
            } finally {
                isRefreshing = false;
            }
        }
        return Promise.reject(error);
    }
);

export default API;
export {authPath, userPath, greenhousePath, sensorPath, actionPath, presetPath, notificationPath,healthPath};</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Mon May 26 2025 15:59:56 GMT+0200 (Central European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
